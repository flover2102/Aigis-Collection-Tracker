<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="referrer" content="no-referrer" />
<meta name="description" content="Aigis Collection Tracker">

<title>Aigis â€” Collection Tracker (Black, Platinum & Gold Chibi)</title>
<style>
/* --- THEME --- */
:root{
  --accent: #5bff9e;
  --accent-muted: #2c4837;
  --bg: #071021;
  --card-bg: rgba(255,255,255,0.03);
  --muted: #9aa6b2;
  --info-color: #38bdf8;
  --danger: #ff4444;
  --danger-soft: #991b1b;
  
  /* Rarity Headers Colors */
  --header-black-bg: linear-gradient(90deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.02) 100%);
  --header-black-text: #fff;
  --header-plat-bg: linear-gradient(90deg, rgba(224, 242, 254, 0.15) 0%, rgba(224, 242, 254, 0.02) 100%);
  --header-plat-text: #e0f2fe;
  --header-gold-bg: linear-gradient(90deg, rgba(253, 224, 71, 0.15) 0%, rgba(253, 224, 71, 0.02) 100%);
  --header-gold-text: #fef08a;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: Inter, system-ui, sans-serif; background: var(--bg); color: #e6f0f6; font-size: 13px; }
.container { max-width: 1200px; margin: 18px auto; padding: 18px; }
.hidden { display: none !important; }

/* --- HEADER --- */
.header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 16px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.title-group { display: flex; flex-direction: column; gap: 12px; }
.h1 { font-size: 20px; font-weight: 700; margin: 0; color: #fff; }

/* --- BANDEAU VIEW MODE --- */
.shared-banner {
  background: rgba(13, 37, 56, 0.95);
  border: 2px solid var(--info-color);
  border-radius: 12px;
  padding: 10px 20px;
  display: inline-flex;
  align-items: center;
  justify-content: space-between;
  gap: 30px;
  min-width: 250px;
  box-shadow: 0 0 15px rgba(56, 189, 248, 0.15), inset 0 0 10px rgba(56, 189, 248, 0.05);
}

.shared-text-group { display: flex; flex-direction: column; gap: 2px; }
.shared-label { font-size: 10px; font-weight: 600; text-transform: uppercase; color: #60a5fa; letter-spacing: 1px; }
.shared-title { font-size: 20px; font-weight: 900; color: #ffffff; text-transform: uppercase; text-shadow: 0 0 8px rgba(56, 189, 248, 0.6); }
.btn-exit {
  background: transparent; border: 1px solid var(--info-color); color: var(--info-color);
  padding: 6px 16px; font-size: 12px; font-weight: bold; border-radius: 6px; cursor: pointer; text-transform: uppercase; transition: all 0.2s;
}
.btn-exit:hover { background: rgba(56, 189, 248, 0.2); box-shadow: 0 0 8px rgba(56, 189, 248, 0.4); }

/* --- STATS --- */
.collection-stats {
  background: rgba(255,255,255,0.05); padding: 8px 16px;
  border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);
  font-family: monospace; 
  position: absolute; left: 50%; transform: translateX(-50%); top: 24px;
}
.collection-stats b { color: var(--accent); }
@media (max-width: 850px) { .collection-stats { position: static; transform: none; margin: 10px 0; } }

/* TOOLS */
.toolbar-actions { display: flex; gap: 6px; align-items: center; margin-left: auto; }

/* --- BOUTONS --- */
.btn {
  padding: 8px 12px; border-radius: 6px; 
  border: 1px solid rgba(255,255,255,.10);
  background-color: var(--accent-muted); 
  color: #e6f0f6; 
  cursor: pointer; transition: all 0.15s; 
  font-size: 12px; font-weight: 500; user-select: none;
}
.btn:hover { background-color: rgba(255,255,255,0.15); }
.btn.active { background-color: var(--accent); color: #071827; border-color: var(--accent); font-weight: 700; }

/* Share Link */
#btn-share-link { background-color: var(--accent-muted); color: #e6f0f6; font-weight: 600; }
#btn-share-link.copied { 
  background-color: var(--accent) !important; 
  color: #071021 !important;
  border-color: var(--accent) !important;
  box-shadow: 0 0 15px var(--accent);
}

/* Inputs */
.toolbar-line { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; justify-content: center; margin-top: 10px; }
.input { padding: 8px 12px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.2); color: inherit; min-width: 250px; }

/* Sort Select */
.sort-select {
  padding: 8px 12px; padding-right: 30px; border-radius: 6px; 
  background-color: var(--accent-muted); color: #e6f0f6; 
  border: 1px solid rgba(255,255,255,0.10); 
  cursor: pointer; font-size: 12px; font-weight: 500; outline: none;
  appearance: none; -webkit-appearance: none;
  background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23e6f0f6%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
  background-repeat: no-repeat; background-position: right 10px center; background-size: 10px;
}
.sort-select option { background-color: #071021; color: #e6f0f6; padding: 8px; }

/* --- FILTERS --- */
.filter-controls { 
  border-top: 1px solid rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.05); 
  padding: 10px 0; margin-top: 12px; display: flex; flex-direction: column; gap: 8px; 
}

.filter-group { display: flex; align-items: flex-start; gap: 8px; }
.filter-group-label { 
  font-size: 12px; color: var(--muted); width: 80px; text-align: right; 
  padding-top: 6px; flex-shrink: 0;
}
.filter-list { display: flex; flex-wrap: wrap; gap: 4px; flex-grow: 1; }

/* SPLIT BUTTONS (Standard) */
.filter-btn-wrapper { 
  display: inline-flex; border-radius: 4px; overflow: hidden; 
  border: 1px solid rgba(255,255,255,.15); background: var(--accent-muted); 
  height: 26px; 
}
.btn-main {
  padding: 0 10px; border: none; background: transparent; color: #e6f0f6; cursor: pointer; font-size: 12px; 
  border-right: 1px solid rgba(0,0,0,0.2); display: flex; align-items: center;
}
.btn-main:hover { background: rgba(255,255,255,0.1); }
.btn-main.active { background: var(--accent); color: #071827; font-weight: 700; }

/* NOUVELLES COULEURS POUR LES BOUTONS RARETÃ‰ */
.btn-main[data-val="Black"].active { 
    background: #334155; /* Onyx / Dark Grey */
    color: #fff; 
    border-color: #64748b;
    box-shadow: 0 0 10px rgba(0,0,0,0.5); 
}
.btn-main[data-val="Platinum"].active { 
    background: #cbd5e1; /* Silver / Metallic */
    color: #0f172a; 
    box-shadow: 0 0 10px rgba(203, 213, 225, 0.4); 
}
.btn-main[data-val="Gold"].active { 
    background: #ca8a04; /* Deep Gold */
    color: #fff; 
    box-shadow: 0 0 10px rgba(234, 179, 8, 0.4); 
}

.btn-minus { 
  padding: 0 8px; border: none; background: rgba(0,0,0,0.2); color: #e6f0f6; cursor: pointer; font-size: 12px; font-weight: bold; 
  display: flex; align-items: center;
}
.btn-minus:hover { background: rgba(255,0,0,0.3); }
.btn-minus.exclude { background: var(--danger-soft); color: #fff; }

/* Dropdowns */
.dropdown-wrapper { position: relative; display: inline-block; }
.dropdown-panel {
  position: absolute; top: 100%; left: 0; 
  background: #0d1a2f; border: 1px solid rgba(255,255,255,.1);
  padding: 8px; border-radius: 6px; display: none; flex-direction: column; gap: 4px;
  z-index: 50; min-width: 180px; margin-top: 4px; box-shadow: 0 8px 24px rgba(0,0,0,0.5);
}
.dropdown-panel:not(.hidden) { display: flex; }
.dropdown-panel .filter-btn-wrapper { width: 100%; }
.dropdown-panel .btn-main { flex-grow: 1; }

/* --- GRID & CARDS --- */
.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 8px; margin-top: 16px; }

/* SECTION HEADER */
.section-header {
  grid-column: 1 / -1; 
  margin-top: 16px; margin-bottom: 4px; padding: 6px 12px;
  border-radius: 4px; font-size: 14px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;
  border-left: 4px solid; display: flex; align-items: center;
}
.section-header[data-rarity="Black"] { background: var(--header-black-bg); color: var(--header-black-text); border-color: #fff; }
.section-header[data-rarity="Platinum"] { background: var(--header-plat-bg); color: var(--header-plat-text); border-color: #93c5fd; }
.section-header[data-rarity="Gold"] { background: var(--header-gold-bg); color: var(--header-gold-text); border-color: #fde047; }

.card {
  padding: 6px; border-radius: 8px; background: var(--card-bg); border: 1px solid rgba(255,255,255,.03);
  text-align: center; cursor: pointer; position: relative; min-height: 120px;
  transition: transform 0.1s ease-out, background 0.1s; display: flex; flex-direction: column; align-items: center;
  content-visibility: auto; contain-intrinsic-size: 110px 140px;
}
.card:hover { background: rgba(255,255,255,0.08); transform: translateY(-2px); }
.card.owned { outline: 2px solid var(--accent); background: rgba(44, 72, 55, 0.4); }

.card[data-rarity="Black"] { border-bottom: 2px solid rgba(255,255,255,0.3); }
.card[data-rarity="Platinum"] { border-bottom: 2px solid rgba(176, 224, 255, 0.3); }
.card[data-rarity="Gold"] { border-bottom: 2px solid rgba(253, 224, 71, 0.3); }

.card img {
  width: 90px; height: 90px; border-radius: 8px; margin-top: 2px; 
  background: rgba(0,0,0,0.2); display: block;
  object-fit: contain; object-position: center;
  transition: opacity 0.3s;
}
body.img-full .card img { width: 100%; height: 120px; background: transparent; }

.card .no-img { width: 90px; height: 90px; margin-top: 2px; border-radius: 8px; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; font-size: 20px; color: rgba(255,255,255,0.2); }
.card .title { font-size: 10px; margin-top: 4px; line-height: 1.2; font-weight: 500; overflow-wrap: break-word; width: 100%; }

.check-indicator {
  position: absolute; top: 4px; right: 4px; width: 16px; height: 16px;
  border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; background: rgba(0,0,0,0.4); z-index: 2; pointer-events: none;
}
.card.owned .check-indicator { background: var(--accent); border-color: var(--accent); }
.card.owned .check-indicator::after { content: 'âœ”'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 10px; color: #071827; font-weight: 900; }

.tags { display: flex; flex-wrap: wrap; gap: 2px; justify-content: center; margin-top: 4px; }
.tag { font-size: 9px; padding: 1px 3px; border-radius: 3px; background: rgba(255,255,255,0.06); color: var(--muted); white-space: nowrap; }
.loading { margin-top: 20px; font-size: 13px; color: var(--accent); font-weight: bold; text-align: center; }
</style>
</head>
<body>
<div class="container">
  
  <div class="header">
    <div class="title-group">
      <h1 class="h1">Aigis â€” Collection Tracker (All Rarities)</h1>
      <div id="shared-banner" class="shared-banner hidden">
        <div class="shared-text-group">
          <span class="shared-label">Shared Collection</span>
          <span class="shared-title">VIEW MODE</span>
        </div>
        <button id="btn-exit-share" class="btn-exit">EXIT</button>
      </div>
    </div>
    
    <div id="collection-stats" class="collection-stats">Collection: 0% (0/0)</div>

    <div class="toolbar-actions">
      <button id="btn-share-link" class="btn">Share Link</button>
      <button id="btn-export" class="btn">Export</button>
      <button id="btn-import" class="btn">Import</button>
      <div class="dropdown-wrapper">
        <button id="btn-options" class="btn">Options â–¾</button>
        <div id="options-panel" class="dropdown-panel hidden" style="right:0;left:auto;min-width:160px;">
          <button id="btn-toggle-imgmode" class="btn">Img: Icon</button>
          <button id="btn-toggle-name" class="btn active">Show Name</button>
          <button id="btn-toggle-tags" class="btn">Show Tags</button>
          <button id="btn-toggle-fodder" class="btn">Show Fodder</button>
        </div>
      </div>
      <input id="file-input" type="file" accept="application/json" class="hidden" />
    </div>
  </div>

  <div class="toolbar-line">
    <input id="search" class="input" placeholder="Search name..." />
    <select id="sort-select" class="sort-select">
      <option value="name">Sort: Name (A-Z)</option>
      <option value="release">Sort: Release (Newest)</option>
    </select>
    <div id="search-stats" style="font-size:12px; color:var(--muted)">0 shown</div>
  </div>

  <div id="filter-controls" class="filter-controls"></div>

  <div id="loading" class="loading hidden">Loading...</div>
  <div id="grid" class="grid" aria-live="polite"></div>
</div>

<script>
const API='https://aigis.fandom.com/api.php';
const LOCAL_OWNED_KEY='aigis-owned-v6';
// V93: New Button Styles
const LOCAL_DATA_KEY='aigis-units-cache-v93'; 

let units=[];
let unitMap=new Map();
let owned=new Set();
let isSharedMode = false;
let showMode='all'; 
let currentSort = 'name';

let showTags = false; 
let showFodder = false;
let showName = true;
let isImgFull = false; 
let openDropdownPanel = null;

const LABEL_MAP = { "Angels Race": "Angels", "Hermits Race": "Hermits", "Deep Sea Units": "Deep Sea", "Makai Units": "Makai", "Male Units": "Male", "Female Units": "Female", "Koihime Units": "Koihime", "Elves": "Elf", "Desert Country": "Desert", "Flower Country": "Flower", "Eastern Country": "Eastern", "New Year's Units": "New Year", "Valentine's Day Units": "Valentine", "Hot Springs Units": "Hot Springs", "Easter Hunts": "Easter", "School Units": "School", "June Bride Units": "Bride", "Summer Units": "Summer", "Halloween Units": "Halloween", "Christmas Units": "Christmas", "Kingdom of Pars": "Pars", "Seven Deadly Sins": "7 Deadly Sins", "Hero Units": "Hero", "Player Units": "Player" };
function cleanLabel(raw) { return LABEL_MAP[raw] || raw.replace(/ Units$/i, '').replace(/ Country$/i, ''); }

const filterStates = { rarity: new Map(), ranges: new Map(), roles: new Map(), genders: new Map(), kingdoms: new Map(), races: new Map(), archetypes: new Map(), seasonal: new Map(), crossover: new Map() };

const FIXED_RARITY = ["Black", "Platinum", "Gold"];
const FIXED_KINGDOMS=["Deep Sea Units","Desert Country","Eastern Country","Flower Country","Kingdom","Makai Units","White Empire"];
const FIXED_ARCHETYPES=["Artillery","Bowmen","Cavalry","Clergy","Dragons","Flying","Gunners","Heavy","Magicians","Nobles"];
const FIXED_SEASONAL=["New Year's Units","Valentine's Day Units","Hot Springs Units","Easter Hunts","School Units","June Bride Units","Summer Units","Halloween Units","Christmas Units"];
const FIXED_CROSSOVER=["Koihime Units","Kingdom of Pars","Seven Deadly Sins"];
const FIXED_RANGES = ["Melee", "Ranged", "Omni"];
const FIXED_ROLES = ["Hero Units", "Player Units"];
const FIXED_GENDERS = ["Male Units", "Female Units"];
const LIST_RACES=["Angels Race","Beastfolk","Birdfolk","Celestials","Dark Elves","Demons","Dragonfolk","Dwarves","Elves","Giants","Goblins","Gods","Half-Demons","Half-Elves","Half-Gods","Hermits Race","Humans","Machines","Merfolk","Nendoroids","Orcs","Spirits","Undead","Vampires","Youkai"];
const UI_RACES = [...LIST_RACES, "Other"];

const el={ search:document.getElementById('search'), grid:document.getElementById('grid'), stats:document.getElementById('search-stats'), colStats:document.getElementById('collection-stats'), loading:document.getElementById('loading'), filterControls: document.getElementById('filter-controls'), sortSelect: document.getElementById('sort-select') };

function debounce(func, wait) {
  let timeout;
  return function(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), wait);
  };
}

async function compressData(ownedSet) { const refUnits = [...units].sort((a,b) => a.numericId - b.numericId); const numBytes = Math.ceil(refUnits.length / 8); const buffer = new Uint8Array(numBytes); refUnits.forEach((u, index) => { if (ownedSet.has(u.id)) buffer[Math.floor(index/8)] |= (1 << (index%8)); }); const stream = new Blob([buffer]).stream().pipeThrough(new CompressionStream("gzip")); const response = await new Response(compressed = stream); let base64 = btoa(String.fromCharCode(...new Uint8Array(await response.arrayBuffer()))); return 'v2-' + base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, ''); }
async function decompressData(encodedString) { let base64 = encodedString.startsWith('v2-') ? encodedString.substring(3) : encodedString; let str = base64.replace(/-/g, '+').replace(/_/g, '/'); while (str.length % 4) str += '='; const stream = new Blob([Uint8Array.from(atob(str), c => c.charCodeAt(0))]).stream().pipeThrough(new DecompressionStream("gzip")); const response = await new Response(stream); const bitmap = new Uint8Array(await response.arrayBuffer()); const result = new Set(); const refUnits = [...units].sort((a,b) => a.numericId - b.numericId); refUnits.forEach((u, index) => { if (Math.floor(index/8) < bitmap.length && (bitmap[Math.floor(index/8)] & (1 << (index%8)))) result.add(u.id); }); return result; }

function saveUnitsToCache(data) { 
  const cleanData = data.map(u => { const { categories, ...rest } = u; return rest; });
  try { localStorage.setItem(LOCAL_DATA_KEY, JSON.stringify({ timestamp: Date.now(), units: cleanData })); } catch(e) { console.warn("Cache full"); } 
}
function saveOwned(){ if (!isSharedMode) localStorage.setItem(LOCAL_OWNED_KEY,JSON.stringify([...owned])); }

function updateStats(){
  if(!units.length) return;
  const totalCol = units.filter(u => (!showFodder && u.isFodder) ? false : true).length;
  const ownedCol = units.filter(u => ((!showFodder && u.isFodder) ? false : true) && owned.has(u.id)).length;
  
  let contextTotal = totalCol;
  let contextOwned = ownedCol;

  const activeRarities = [];
  if (filterStates.rarity.get('Black') === 1) activeRarities.push('Black');
  if (filterStates.rarity.get('Platinum') === 1) activeRarities.push('Platinum');
  if (filterStates.rarity.get('Gold') === 1) activeRarities.push('Gold');

  if(activeRarities.length === 1) {
      const r = activeRarities[0];
      contextTotal = units.filter(u => u.rarity === r && (!showFodder && u.isFodder ? false : true)).length;
      contextOwned = units.filter(u => u.rarity === r && owned.has(u.id) && (!showFodder && u.isFodder ? false : true)).length;
  }

  const percent = contextTotal > 0 ? ((contextOwned / contextTotal) * 100).toFixed(1) : 0;
  el.colStats.innerHTML = `Collection${isSharedMode?" (View)":""}: <b>${percent}%</b> <span style="opacity:0.7">(${contextOwned}/${contextTotal})</span>`;
}

function normalize(s){return String(s||'').replace(/^Category:/i,'').replace(/_/g,' ').trim();}
function nk(s){return String(s||'').toLowerCase().trim();}
function buildApiTags(catList){return (catList||[]).map(c=>normalize(c.title||c));}
function determineRange(tags){ const t = (tags||[]).map(x => nk(x)); if(t.some(x => x.includes('omni'))) return 'Omni'; if(t.some(x => x.includes('rearguard'))) return 'Ranged'; return 'Melee'; }

function processUnitData(u) {
    const apiTags = buildApiTags(u.apiTags||u.categories||[]);
    let races = apiTags.filter(t => LIST_RACES.includes(t));
    if (races.length === 0) races = ["Other"];
    const pid = parseInt(u.pageid || u.id, 10) || 0;
    
    let r = 'Gold';
    if(apiTags.some(t => t === 'Rarity:Black' || t === 'Black Units')) r = 'Black';
    else if(apiTags.some(t => t === 'Rarity:Platinum' || t === 'Platinum Units')) r = 'Platinum';
    else if(apiTags.some(t => t === 'Rarity:Gold' || t === 'Gold Units')) r = 'Gold';
    else if(apiTags.some(t => t === 'Rarity:Sapphire' || t === 'Sapphire Units')) r = 'Sapphire';
    
    return { 
        id: String(pid), numericId: pid, 
        title: normalize(u.title || u.pageTitle || u.name), 
        imgIcon: u.imgIcon, imgFull: u.imgFull, 
        apiTags: apiTags, tags: u.tags || [], 
        rarity: r, 
        range: determineRange(apiTags), 
        genders: apiTags.filter(t => FIXED_GENDERS.includes(t)), 
        roles: apiTags.filter(t => FIXED_ROLES.includes(t)), 
        kingdoms: apiTags.filter(t => FIXED_KINGDOMS.includes(t)), 
        races: races, 
        archetypes: apiTags.filter(t => FIXED_ARCHETYPES.includes(t)), 
        seasonal: apiTags.filter(t => FIXED_SEASONAL.includes(t)), 
        crossover: apiTags.filter(t => FIXED_CROSSOVER.includes(t)), 
        isFodder: apiTags.some(t => nk(t) === 'fodder units') 
    };
}

function matchesFilters(u, searchQuery = null){ 
  if (!showFodder && u.isFodder) return false; 
  if (searchQuery && !nk(u.title).includes(searchQuery)) return false; 
  if(showMode==='owned' && !owned.has(u.id)) return false; 
  if(showMode==='notowned' && owned.has(u.id)) return false; 

  if (filterStates.rarity.size > 0) {
      const state = filterStates.rarity.get(u.rarity);
      const hasInclude = [...filterStates.rarity.values()].some(v => v === 1);
      
      if (state === -1) return false; 
      if (hasInclude && state !== 1) return false; 
  } 

  if (filterStates.ranges.size > 0) { const state = filterStates.ranges.get(u.range); if (state === -1) return false; const hasGreen = [...filterStates.ranges.values()].some(v => v === 1); if (hasGreen && state !== 1) return false; } 
  if (!checkFilterState(u.roles, filterStates.roles)) return false; 
  if (!checkFilterState(u.genders, filterStates.genders)) return false; 
  if (!checkFilterState(u.kingdoms, filterStates.kingdoms)) return false; 
  if (!checkFilterState(u.races, filterStates.races)) return false; 
  if (!checkFilterState(u.archetypes, filterStates.archetypes)) return false; 
  if (!checkFilterState(u.seasonal, filterStates.seasonal)) return false; 
  if (!checkFilterState(u.crossover, filterStates.crossover)) return false; 
  return true; 
}

function checkFilterState(unitTags, filterMap) { if (filterMap.size === 0) return true; let includeRequired = false; let hasIncluded = false; for (const [tag, state] of filterMap) { const match = unitTags.some(t => nk(t) === nk(tag)) || (tag === "Other" && unitTags.includes("Other")); if (state === -1 && match) return false; if (state === 1) { includeRequired = true; if (match) hasIncluded = true; } } if (includeRequired && !hasIncluded) return false; return true; }

// --- DOM GENERATION ---
function createHeaderDOM(rarity) {
    const h = document.createElement('div');
    h.className = 'section-header';
    h.dataset.type = 'header';
    h.dataset.rarity = rarity;
    h.textContent = `${rarity} Units`;
    return h;
}

function createCardDOM(u) {
    const card=document.createElement('div'); 
    card.className='card';
    card.dataset.id = u.id;
    card.dataset.rarity = u.rarity;
    
    if(owned.has(u.id)) card.classList.add('owned');
    const checkbox = document.createElement('div'); checkbox.className = 'check-indicator'; card.appendChild(checkbox);
    
    let src = isImgFull ? (u.imgFull || u.imgIcon) : (u.imgIcon || u.imgFull);
    if(src) { 
        const img=document.createElement('img'); 
        img.src=src; img.alt=u.title; img.loading = "lazy"; img.decoding = "async";
        card.appendChild(img); 
    } else { 
        const ph=document.createElement('div'); ph.className='no-img'; ph.textContent='?'; card.appendChild(ph); 
    }
    
    if (showName) { const title=document.createElement('div'); title.className='title'; title.textContent=u.title; card.appendChild(title); }
    const wikiLink = document.createElement('a'); wikiLink.href=`https://aigis.fandom.com/wiki/${encodeURIComponent(u.title.replace(/ /g,'_'))}`; wikiLink.target='_blank'; wikiLink.className='icon-link'; wikiLink.textContent='Wiki ðŸ”—'; wikiLink.style.fontSize='10px'; wikiLink.style.marginTop='auto'; wikiLink.addEventListener('click', e => e.stopPropagation()); card.appendChild(wikiLink);
    
    if(showTags){ 
        const tagsWrap=document.createElement('div'); tagsWrap.className='tags'; 
        const ignoredTags = ["Black Units", "Male Units", "Female Units", "Platinum Units", "Sapphire Units", "Gold Units", "Chibi Units", ...FIXED_KINGDOMS]; 
        const displayTags = (u.apiTags||[]).filter(t => !ignoredTags.includes(t) && !t.includes("Rarity")); 
        Array.from(new Set(displayTags)).slice(0,5).forEach(t=>{ const tk=document.createElement('span'); tk.className='tag'; tk.textContent=cleanLabel(t); tagsWrap.appendChild(tk); }); 
        card.appendChild(tagsWrap); 
    }
    return card;
}

// --- RENDER LOGIC ---

function updateView() {
    const searchQuery = nk(el.search.value || '');
    let totalCount = 0;
    
    const counts = { "Black": 0, "Platinum": 0, "Gold": 0 };
    
    const children = el.grid.children;
    for(let i=0; i<children.length; i++) {
        const child = children[i];
        if(child.dataset.type === 'header') continue;
        
        const u = unitMap.get(child.dataset.id);
        if(!u) continue; 
        
        if(matchesFilters(u, searchQuery)) {
            child.classList.remove('hidden');
            if(counts[u.rarity] !== undefined) counts[u.rarity]++;
            totalCount++;
        } else {
            child.classList.add('hidden');
        }
    }
    
    for(let i=0; i<children.length; i++) {
        const child = children[i];
        if(child.dataset.type === 'header') {
            const r = child.dataset.rarity;
            if (counts[r] > 0) child.classList.remove('hidden');
            else child.classList.add('hidden');
        }
    }

    el.stats.textContent = `${totalCount} shown`;
    updateStats();
}

function render(){
  if(!units || units.length === 0) { el.grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:20px;">No units found. Reload page.</div>'; return; }
  
  // LOGIQUE DE TRI
  const rWeight = { "Black": 3, "Platinum": 2, "Gold": 1 };
  
  const sortedUnits = [...units].sort((a,b) => {
      const rwA = rWeight[a.rarity] || 0;
      const rwB = rWeight[b.rarity] || 0;
      if (rwA !== rwB) return rwB - rwA; 
      if (currentSort === 'release') return b.numericId - a.numericId;
      return a.title.localeCompare(b.title);
  });
  
  el.grid.innerHTML='';
  const frag = document.createDocumentFragment();
  
  let currentRarity = null;
  
  for(const u of sortedUnits){
      if (u.rarity !== currentRarity) {
          if (["Black", "Platinum", "Gold"].includes(u.rarity)) {
             frag.appendChild(createHeaderDOM(u.rarity));
          }
          currentRarity = u.rarity;
      }
      frag.appendChild(createCardDOM(u));
  }
  el.grid.appendChild(frag); 
  
  updateView(); 
}

function handleGridClick(e) {
    if(isSharedMode) return;
    const card = e.target.closest('.card');
    if(!card) return;
    const id = card.dataset.id;
    if(!id) return;
    if(owned.has(id)) {
        owned.delete(id);
        card.classList.remove('owned');
    } else {
        owned.add(id);
        card.classList.add('owned');
    }
    saveOwned();
    updateStats();
}

document.addEventListener('DOMContentLoaded', () => {
  el.grid.addEventListener('click', handleGridClick);
  el.sortSelect.addEventListener('change', (e) => { currentSort = e.target.value; render(); });
  el.search.oninput = debounce(() => updateView(), 250);

  document.getElementById('btn-share-link').addEventListener('click', async (e) => {
    if(owned.size===0) return alert('Empty');
    const btn=e.target; const txt=btn.textContent;
    try {
      const encoded = await compressData(owned);
      const url = `${window.location.href.split('?')[0]}?share=${encoded}`;
      await navigator.clipboard.writeText(url);
      btn.textContent = "Copied!"; btn.classList.add('copied'); 
      setTimeout(()=> {btn.textContent=txt; btn.classList.remove('copied')}, 1500);
    } catch(x){alert('Error');}
  });
  document.getElementById('btn-export').onclick = () => { const b=new Blob([JSON.stringify({owned:[...owned],units})],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='aigis.json'; a.click(); };
  document.getElementById('btn-import').onclick = () => document.getElementById('file-input').click();
  document.getElementById('file-input').onchange = async (e) => { try{ const d=JSON.parse(await e.target.files[0].text()); if(d.owned) owned=new Set(d.owned); if(d.units) {units=d.units; units.forEach(u => unitMap.set(u.id, u)); saveUnitsToCache(units);} if(!isSharedMode) saveOwned(); render(); }catch(x){} };
  document.getElementById('btn-exit-share').onclick = () => { window.location.href = window.location.pathname; };

  const optionsBtn = document.getElementById('btn-options'); const optionsPanel = document.getElementById('options-panel');
  const toggleTagsBtn = document.getElementById('btn-toggle-tags'); const toggleFodderBtn = document.getElementById('btn-toggle-fodder');
  const toggleNameBtn = document.getElementById('btn-toggle-name'); const toggleImgBtn = document.getElementById('btn-toggle-imgmode');
  
  if (optionsBtn) {
    optionsBtn.addEventListener('click', (e) => { e.stopPropagation(); const isHidden = optionsPanel.classList.contains('hidden'); if (openDropdownPanel) closeOpenDropdown(); optionsPanel.classList.toggle('hidden', !isHidden); optionsBtn.classList.toggle('active', isHidden); });
    toggleTagsBtn.addEventListener('click', (e) => { e.stopPropagation(); showTags = !showTags; toggleTagsBtn.classList.toggle('active', showTags); render(); });
    toggleNameBtn.addEventListener('click', (e) => { e.stopPropagation(); showName = !showName; toggleNameBtn.classList.toggle('active', showName); render(); });
    toggleFodderBtn.addEventListener('click', (e) => { e.stopPropagation(); showFodder = !showFodder; toggleFodderBtn.classList.toggle('active', showFodder); updateView(); });
    toggleImgBtn.addEventListener('click', (e) => { e.stopPropagation(); isImgFull = !isImgFull; toggleImgBtn.textContent = isImgFull ? "Img: Full" : "Img: Icon"; document.body.className = isImgFull ? 'img-full' : ''; render(); });
  }
  document.addEventListener('click', e => { if(openDropdownPanel && !openDropdownPanel.wrapper.contains(e.target)) { openDropdownPanel.classList.add('hidden'); openDropdownPanel.previousElementSibling.classList.remove('active'); openDropdownPanel=null; } if(!optionsPanel.classList.contains('hidden') && !optionsBtn.contains(e.target) && !optionsPanel.contains(e.target)) { optionsPanel.classList.add('hidden'); optionsBtn.classList.remove('active'); } });
  
  renderStaticFilters();
  init();
});

// CrÃ©ateur de bouton SIMPLE (Sans le "-")
function createSimpleButton(k, map) {
  const w=document.createElement('div'); w.className='filter-btn-wrapper';
  // On retire la bordure car pas de split
  w.style.borderRight = "1px solid rgba(255,255,255,.15)"; 
  
  const b=document.createElement('button'); b.className='btn-main'; b.textContent=cleanLabel(k);
  b.dataset.val = k; 
  b.style.width = "100%"; // Prend toute la place
  b.style.borderRight = "none";
  
  b.onclick=()=>{ 
    const v=map.get(k); 
    if(v===1){ map.delete(k); b.classList.remove('active'); }
    else{ map.set(k,1); b.classList.add('active'); } 
    updateView(); 
  };
  
  w.appendChild(b); return w;
}

// CrÃ©ateur de bouton SPLIT (Avec le "-")
function createSplitButton(k,l,m) {
  const w=document.createElement('div'); w.className='filter-btn-wrapper';
  const b1=document.createElement('button'); b1.className='btn-main'; b1.textContent=cleanLabel(l);
  b1.dataset.val = l; 
  const b2=document.createElement('button'); b2.className='btn-minus'; b2.textContent='-';
  b1.onclick=()=>{ const v=m.get(k); if(v===1){m.delete(k);b1.classList.remove('active');}else{m.set(k,1);b1.classList.add('active');b2.classList.remove('exclude');} updateView(); };
  b2.onclick=()=>{ const v=m.get(k); if(v===-1){m.delete(k);b2.classList.remove('exclude');}else{m.set(k,-1);b2.classList.add('exclude');b1.classList.remove('active');} updateView(); };
  w.append(b1,b2); return w;
}

function createButtonGroup(l,lst,m) { 
  const g=document.createElement('div'); g.className='filter-group'; 
  const lb=document.createElement('div'); lb.className='filter-group-label'; lb.textContent=l+' :'; 
  const container=document.createElement('div'); container.className='filter-list';
  g.appendChild(lb); 
  lst.forEach(o=>container.appendChild(createSplitButton(o,o,m))); 
  g.appendChild(container);
  el.filterControls.appendChild(g); 
}

function createDropdown(l,lst,m) {
  const w=document.createElement('div'); w.className='dropdown-wrapper'; const b=document.createElement('button'); b.className='btn'; b.textContent=l+' â–¾'; const p=document.createElement('div'); p.className='dropdown-panel hidden';
  const h=document.createElement('div'); h.className='filter-btn-wrapper'; h.style.marginBottom='8px';
  const all=document.createElement('button'); all.className='btn-main'; all.textContent='Select All'; all.style.textAlign='center'; all.style.color='var(--accent)';
  all.onclick=()=>{ const on=lst.every(o=>m.get(o)===1); if(on){m.clear();Array.from(p.querySelectorAll('.btn-main')).forEach(x=>x.classList.remove('active'));Array.from(p.querySelectorAll('.btn-minus')).forEach(x=>x.classList.remove('exclude'));}else{lst.forEach(o=>m.set(o,1));Array.from(p.querySelectorAll('.btn-main')).forEach(x=>x.classList.add('active'));Array.from(p.querySelectorAll('.btn-minus')).forEach(x=>x.classList.remove('exclude'));} updateView(); };
  const none=document.createElement('button'); none.className='btn-minus'; none.textContent='-'; none.style.color='#ff4444';
  none.onclick=()=>{ const off=lst.every(o=>m.get(o)===-1); if(off){m.clear();Array.from(p.querySelectorAll('.btn-minus')).forEach(x=>x.classList.remove('exclude'));}else{lst.forEach(o=>m.set(o,-1));Array.from(p.querySelectorAll('.btn-minus')).forEach(x=>x.classList.add('exclude'));Array.from(p.querySelectorAll('.btn-main')).forEach(x=>x.classList.remove('active'));} updateView(); };
  h.append(all,none); p.appendChild(h); lst.forEach(o=>p.appendChild(createSplitButton(o,o,m)));
  b.onclick=(e)=>{e.stopPropagation(); if(openDropdownPanel && openDropdownPanel!==p) openDropdownPanel.classList.add('hidden'); p.classList.toggle('hidden'); b.classList.toggle('active',!p.classList.contains('hidden')); openDropdownPanel=p.classList.contains('hidden')?null:p; };
  w.append(b,p); return w;
}

function renderStaticFilters() {
  el.filterControls.innerHTML = ''; 
  
  const statusGroup = document.createElement('div'); statusGroup.className = 'filter-group';
  const statusLabel = document.createElement('div'); statusLabel.className = 'filter-group-label'; statusLabel.textContent = 'Status :';
  const statusList = document.createElement('div'); statusList.className = 'filter-list';
  const ownedBtn = document.createElement('button'); ownedBtn.className = 'btn'; ownedBtn.textContent = 'Owned'; if (showMode === 'owned') ownedBtn.classList.add('active');
  ownedBtn.addEventListener('click', () => { if (showMode === 'owned') { showMode = 'all'; ownedBtn.classList.remove('active'); } else { showMode = 'owned'; ownedBtn.classList.add('active'); notOwnedBtn.classList.remove('active'); } updateView(); });
  const notOwnedBtn = document.createElement('button'); notOwnedBtn.className = 'btn'; notOwnedBtn.textContent = 'Unowned'; if (showMode === 'notowned') notOwnedBtn.classList.add('active');
  notOwnedBtn.addEventListener('click', () => { if (showMode === 'notowned') { showMode = 'all'; notOwnedBtn.classList.remove('active'); } else { showMode = 'notowned'; notOwnedBtn.classList.add('active'); ownedBtn.classList.remove('active'); } updateView(); });
  statusList.append(ownedBtn, notOwnedBtn);
  statusGroup.append(statusLabel, statusList);
  el.filterControls.appendChild(statusGroup);
  
  // Custom Rarity Group (Simple Buttons)
  const rarityGroup = document.createElement('div'); rarityGroup.className = 'filter-group';
  const rarityLabel = document.createElement('div'); rarityLabel.className = 'filter-group-label'; rarityLabel.textContent = 'Rarity :';
  const rarityList = document.createElement('div'); rarityList.className = 'filter-list';
  FIXED_RARITY.forEach(r => rarityList.appendChild(createSimpleButton(r, filterStates.rarity)));
  rarityGroup.append(rarityLabel, rarityList);
  el.filterControls.appendChild(rarityGroup);

  createButtonGroup("Type", FIXED_RANGES, filterStates.ranges);
  createButtonGroup("Role", FIXED_ROLES, filterStates.roles);
  createButtonGroup("Gender", FIXED_GENDERS, filterStates.genders);
  createButtonGroup("Kingdom", FIXED_KINGDOMS, filterStates.kingdoms);
  createButtonGroup("Race", UI_RACES, filterStates.races);
  createButtonGroup("Archetype", FIXED_ARCHETYPES, filterStates.archetypes);
  
  const specGroup = document.createElement('div'); specGroup.className = 'filter-group';
  const specLabel = document.createElement('div'); specLabel.className = 'filter-group-label'; specLabel.textContent = 'Special :';
  const specList = document.createElement('div'); specList.className = 'filter-list';
  specList.appendChild(createDropdown("Seasonal", FIXED_SEASONAL, filterStates.seasonal));
  specList.appendChild(createDropdown("Crossover", FIXED_CROSSOVER, filterStates.crossover));
  specGroup.append(specLabel, specList);
  el.filterControls.appendChild(specGroup);

  const blackBtn = document.querySelector('.btn-main[data-val="Black"]');
  if(blackBtn) blackBtn.classList.add('active');
}

async function safeFetch(url) { const res = await fetch(url); if(!res.ok) throw new Error('Network error'); return res; }

async function fetchCategoryMembers(catName){
  const all=[]; let c=null;
  do { const res=await safeFetch(`${API}?action=query&list=categorymembers&cmtitle=${catName}&cmlimit=500&format=json&origin=*`+(c?`&cmcontinue=${c}`:'')); const d=await res.json(); all.push(...d.query.categorymembers); c=d.continue?.cmcontinue; } while(c);
  return all;
}

function chunkArray(array, size) {
  const result = [];
  for (let i = 0; i < array.length; i += size) {
    result.push(array.slice(i, i + size));
  }
  return result;
}

async function initFromWiki(){
  el.loading.textContent='Downloading Lists (Black / Plat / Chibi)...'; el.loading.classList.remove('hidden');
  try {
    const [listBlack, listPlat, listChibi] = await Promise.all([
        fetchCategoryMembers('Category:Rarity:Black'),
        fetchCategoryMembers('Category:Rarity:Platinum'),
        fetchCategoryMembers('Category:Chibi_Units')
    ]);
    const list = [...listBlack, ...listPlat, ...listChibi];
    
    units = list.map(m => ({
      id: String(m.pageid), numericId: parseInt(m.pageid), 
      title: m.title.replace(/^Category:/i,'').replace(/_/g,' ').trim(),
      imgIcon: null, imgFull: null, 
      apiTags: [], tags: [], rarity: 'Black', range: 'Melee', genders: [], roles: [], kingdoms: [], races: [], archetypes: [], seasonal: [], crossover: [], isFodder: false
    }));
    
    unitMap.clear();
    units.forEach(u => unitMap.set(u.id, u));
    units = Array.from(unitMap.values());

    render(); 
    
    el.loading.textContent='Hunting Icons...';
    
    const candidates = []; const candidateToId = new Map();
    list.forEach(m => {
      let base = m.title.replace(/ \((Black|Platinum|Gold)\)/,'').trim();
      let c1=`File:${base} AW Icon.png`, c2=`File:${base} Icon.png`, c3=`File:${m.title} AW Icon.png`, c4=`File:${m.title} Icon.png`;
      candidateToId.set(c1, m.pageid); candidateToId.set(c2, m.pageid);
      candidateToId.set(c3, m.pageid); candidateToId.set(c4, m.pageid);
      candidates.push(c1,c2,c3,c4);
    });
    
    const uniqueCandidates = [...new Set(candidates)];
    const iconBatches = chunkArray(uniqueCandidates, 50);
    
    const iconPromises = iconBatches.map(batch => {
        const s = batch.join('|');
        return safeFetch(`${API}?action=query&titles=${s}&prop=imageinfo&iiprop=url&format=json&origin=*`)
            .then(res => res.json())
            .then(d => {
                if(!d.query?.pages) return;
                Object.values(d.query.pages).forEach(p => {
                    if(!p.missing && p.imageinfo){
                        const uid = String(candidateToId.get(p.title));
                        if(!uid) return;
                        const u = unitMap.get(uid);
                        if(u && (!u.imgIcon || p.title.includes('AW'))) {
                            u.imgIcon = p.imageinfo[0].url;
                            const card = document.querySelector(`.card[data-id="${uid}"]`);
                            if(card) {
                                const existingImg = card.querySelector('img');
                                if(!existingImg) {
                                    const noImg = card.querySelector('.no-img'); if(noImg) noImg.remove();
                                    const img = document.createElement('img'); img.src = u.imgIcon; img.alt = u.title; img.loading = "lazy"; img.decoding="async";
                                    const titleEl = card.querySelector('.title'); if(titleEl) card.insertBefore(img, titleEl); else card.appendChild(img);
                                } else if(p.title.includes('AW')) existingImg.src = u.imgIcon;
                            }
                        }
                    }
                });
            })
            .catch(e => console.error("Icon batch failed", e));
    });

    const detailBatches = chunkArray(units.map(m=>m.numericId), 40);
    const detailPromises = detailBatches.map(batch => {
        const s = batch.join('|');
        return safeFetch(`${API}?action=query&pageids=${s}&prop=pageimages|categories&pithumbsize=150&cllimit=500&redirects=1&format=json&formatversion=2&origin=*`)
            .then(res => res.json())
            .then(d => {
                 if(d.query?.pages) d.query.pages.forEach(p => {
                     const u = unitMap.get(String(p.pageid));
                     if(u) {
                         u.imgFull = p.thumbnail?.source || p.original?.source;
                         u.apiTags = (p.categories||[]).map(c=>c.title);
                         const processed = processUnitData({ ...u, categories: p.categories });
                         Object.assign(u, processed);
                         const card = document.querySelector(`.card[data-id="${u.id}"]`);
                         if(card) card.dataset.rarity = u.rarity;
                     }
                 });
            })
            .catch(e => console.error("Detail batch failed", e));
    });

    await Promise.all([...iconPromises, ...detailPromises]);
    saveUnitsToCache(units); 
    render(); 
    el.loading.classList.add('hidden');
    
  } catch(e){ 
      el.loading.textContent='Error'; 
      console.error(e); 
  }
}

async function init() {
  try {
      const storedOwned = localStorage.getItem(LOCAL_OWNED_KEY);
      if (storedOwned) {
          owned = new Set(JSON.parse(storedOwned));
      }
  } catch(e) { console.error("Error loading owned list", e); }
  const cachedData = localStorage.getItem(LOCAL_DATA_KEY);
  let unitsLoaded = false;
  if (cachedData) { 
      try { 
          const d = await decompressFromB64(cachedData);
          if (Date.now() - d.timestamp < 86400000 && Array.isArray(d.units)) { 
              units = d.units; 
              unitMap.clear();
              units.forEach(u => unitMap.set(u.id, u));
              unitsLoaded = true;
          } 
      } catch(e) { console.warn('Cache invalide', e); } 
  }
  if (!unitsLoaded) { 
      await initFromWiki(); 
  }

  filterStates.rarity.set('Black', 1);

  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.has('share') && units.length > 0) { 
      try { 
          owned = await decompressData(urlParams.get('share')); 
          isSharedMode = true; 
          showMode = 'owned'; 
          document.getElementById('shared-banner').classList.remove('hidden'); 
          document.body.classList.add('read-only'); 
          document.querySelectorAll('.filter-controls button').forEach(b => { 
              if(b.textContent === 'Owned') b.classList.add('active'); 
              if(b.textContent === 'Unowned') b.classList.remove('active'); 
          }); 
      } catch(e) { console.error("Share link error", e); } 
  } 

  el.loading.classList.add('hidden'); 
  render();
  updateView();
  renderStaticFilters(); 
}
</script>
</body>
</html>
